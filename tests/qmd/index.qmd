## Overview

This document presents the output of a [GitHub Action](https://docs.github.com/en/actions) workflow that sets up NetLogo and runs experiments using [Quarto](https://quarto.org/) and the [`logolink`](https://danielvartan.github.io/logolink/) R package.

See the repository [README](https://github.com/danielvartan/logoactions#logoactions) for more details.

## Set the Environment

### Load Packages

```{r}
#| label: Set the Environment
#| output: false

library(logolink) # github.com/danielvartan/logolink

library(dplyr)
library(ggplot2)
library(magrittr)
```

### Set `ggplot2` Theme

```{r}
theme_set(
  theme_bw() +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      legend.frame = element_blank(),
      legend.ticks = element_line(color = "white")
    )
)
```

## Wolf Sheep Predation Model

### Set Model Path

```{r}
#| label: Wolf Sheep Predation Model

model_path <-
  find_netlogo_home() |>
  file.path(
    "models",
    "IABM Textbook",
    "chapter 4",
    "Wolf Sheep Simple 5.nlogox"
  )
```

### Create Experiment

```{r}
setup_file <- create_experiment(
  name = "Wolf Sheep Simple Model Analysis",
  repetitions = 10,
  sequential_run_order = TRUE,
  run_metrics_every_step = TRUE,
  time_limit = 1000,
  setup = 'setup',
  go = 'go',
  metrics = c(
    'count wolves',
    'count sheep'
  ),
  constants = list(
    "number-of-sheep" = 500,
    "number-of-wolves" = list(
      first = 5,
      step = 1,
      last = 15
    ),
    "movement-cost" = 0.5,
    "grass-regrowth-rate" = 0.3,
    "energy-gain-from-grass" = 2,
    "energy-gain-from-sheep" = 5
  )
)
```

### Run Experiment

```{r}
#| output: false

results <-
  model_path |>
  run_experiment(setup_file = setup_file)
```

```{r}
results |> glimpse()
```

```{r}
results
```

### Plot Results

```{r}
#| output: false

plot_data <-
  results |>
  extract2("table") |>
  summarize(
    across(everything(), ~ mean(.x, na.rm = TRUE)),
    .by = c(step, number_of_wolves)
  ) |>
  arrange(number_of_wolves, step)
```

```{r}
plot_data |>
  mutate(
    number_of_wolves = as.factor(number_of_wolves)
  ) |>
  ggplot(
    aes(
      x = step,
      y = count_sheep,
      group = number_of_wolves,
      color = number_of_wolves
    )
  ) +
  geom_line() +
  labs(
    x = "Time Step",
    y = "Average Number of Sheep",
    color = "Wolves"
  )
```

## Spread of Disease Model

### Set Model Path

```{r}
#| label: Spread of Disease Model

model_path <-
  find_netlogo_home() |>
  file.path(
    "models",
    "IABM Textbook",
    "chapter 6",
    "Spread of Disease.nlogox"
  )
```

### Create Experiment

```{r}
setup_file <- create_experiment(
  name = "Population Density (Runtime)",
  repetitions = 10,
  sequential_run_order = TRUE,
  run_metrics_every_step = TRUE,
  time_limit = 1000,
  setup = 'setup',
  go = 'go',
  metrics = c(
    'count turtles with [infected?]'
  ),
  constants = list(
    "variant" = "mobile",
    "num-people" = list(
      first = 50,
      step = 50,
      last = 200
    ),
    "connections-per-node" = 4.1,
    "num-infected" = 1,
    "disease-decay" = 0
  )
)
```

### Run Experiment

```{r}
#| output: false

results <-
  model_path |>
  run_experiment(setup_file = setup_file)
```

```{r}
results |> glimpse()
```

```{r}
results
```

### Tidy Data

```{r}
data <-
  results |>
  extract2("table") |>
  rename(infected = count_turtles_with_infected) |>
  mutate(
    variant = as.factor(variant),
    frac_infected = infected / num_people
  ) |>
  arrange(run_number, num_infected, step)
```

```{r}
data |> glimpse()
```

```{r}
data
```

### Plot Data

```{r}
data |>
  mutate(
    num_people = as.factor(num_people)
  ) |>
  ggplot(
    aes(
      x = step,
      y = frac_infected,
      color = num_people
    )
  ) +
  geom_point(
    aes(shape = num_people),
    size = 1,
    alpha = 0.75
  ) +
  scale_x_continuous(breaks = seq(0, max(data$step), 100)) +
  labs(
    x = "Steps",
    y = "Fraction of Infected",
    title = "Infected Over Time",
    color = "People",
    shape = "People"
  )
```

```{r}
plot <-
  data |>
  ggplot(
    aes(
      x = step,
      y = frac_infected, # infected
      color = as.factor(num_people)
    )
  ) +
  scale_x_continuous(
    breaks = seq(0, max(data$step), 100)
  ) +
  labs(
    x = "Steps",
    y = "Fraction of Infected",
    title = "Infected Over Time",
    color = "People"
  )

data_i <-
  data |>
  group_by(num_people, run_number) |>
  group_split()

for (i in data_i) {
  plot <-
    plot +
    geom_line(
      data = i,
      aes(x = step, y = frac_infected),
      linewidth = 1,
      alpha = 0.75
    )
}

plot
```

### Summarize Data

```{r}
summarized_data <-
  data |>
  select(num_people, step, infected, frac_infected) |>
  summarize(
    mean = mean(frac_infected, na.rm = TRUE),
    sd = sd(frac_infected, na.rm = TRUE),
    .by = c(num_people, step)
  ) |>
  arrange(num_people, step)
```

```{r}
summarized_data |> glimpse()
```

```{r}
summarized_data
```

### Plot Summarized Data with SD Error Bars

```{r}
summarized_data |>
  filter(step %% 10 == 0) |>
  ggplot(
    aes(
      x = step,
      y = mean,
      color = as.factor(num_people)
    )
  ) +
  geom_point(
    aes(shape = as.factor(num_people)),
    size = 1,
    alpha = 0.75
  ) +
  geom_errorbar(
    aes(
      ymin = mean + sd,
      ymax = mean - sd
    ),
    width = 5
  ) +
  geom_line() +
  scale_x_continuous(
    breaks = seq(0, max(summarized_data$step), 100)
  ) +
  labs(
    title = "Infected Over Time",
    x = "Steps",
    y = "Fraction of Infected",
    color = "People",
    shape = "People"
  )
```

### Plot Summarized Data with SE Error Bars

```{r}
summarized_data |>
  filter(step %% 10 == 0) |>
  mutate(se = sd / sqrt(10)) |>
  ggplot(aes(
    x = step,
    y = mean,
    color = as.factor(num_people)
  )) +
  geom_point(
    aes(shape = as.factor(num_people)),
    size = 1,
    alpha = 0.75
  ) +
  geom_errorbar(
    aes(
      ymin = mean + se,
      ymax = mean - se
    ),
    width = 5
  ) +
  geom_line() +
  scale_x_continuous(
    breaks = seq(0, max(summarized_data$step), 100)
  ) +
  labs(
    title = "Infected Over Time",
    x = "Steps",
    y = "Fraction of Infected",
    color = "People",
    shape = "People"
  )
```
